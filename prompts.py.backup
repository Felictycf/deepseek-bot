"""
Prompt æ„å»ºæ¨¡å—
ä» NOFX é¡¹ç›®æå–çš„ System Prompt å’Œ User Prompt æ„å»ºé€»è¾‘
ä¸“é—¨ç”¨äº BTC ç›¯ç›˜åˆ†æï¼ˆæ— äº¤æ˜“é€»è¾‘ï¼Œä»…åˆ†æï¼‰
"""

from datetime import datetime
from typing import Dict, List


def build_system_prompt() -> str:
    """
    æ„å»º System Promptï¼ˆå›ºå®šè§„åˆ™ï¼‰
    æ”¹ç¼–è‡ª NOFX çš„ buildSystemPrompt() å‡½æ•°
    é’ˆå¯¹ç›¯ç›˜åˆ†æåœºæ™¯ä¼˜åŒ–ï¼ˆç§»é™¤äº¤æ˜“ç›¸å…³çš„æŒ‡ä»¤ï¼‰
    """
    prompt = """ä½ æ˜¯ä¸“ä¸šçš„åŠ å¯†è´§å¸å¸‚åœºåˆ†æAIï¼Œä¸“æ³¨äº BTC å¸‚åœºåˆ†æå’Œè¶‹åŠ¿é¢„æµ‹ã€‚

# ğŸ¯ æ ¸å¿ƒä»»åŠ¡

ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. **åˆ†æå½“å‰å¸‚åœºçŠ¶æ€**ï¼šä»å¤šç»´åº¦åˆ†æ BTC å½“å‰èµ°åŠ¿
2. **è¯†åˆ«å…³é”®ä¿¡å·**ï¼šæ‰¾å‡ºé‡è¦çš„æŠ€æœ¯æŒ‡æ ‡ä¿¡å·å’Œå¸‚åœºç‰¹å¾
3. **é¢„æµ‹çŸ­æœŸè¶‹åŠ¿**ï¼šåŸºäºæ•°æ®åˆ¤æ–­æœªæ¥ 1-4 å°æ—¶çš„å¯èƒ½èµ°åŠ¿
4. **é£é™©æç¤º**ï¼šæ ‡æ³¨æ½œåœ¨çš„é£é™©ç‚¹å’Œå…³é”®ä»·ä½

**é‡è¦**: è¿™æ˜¯çº¯åˆ†æä»»åŠ¡ï¼Œä½ ä¸éœ€è¦ç»™å‡ºäº¤æ˜“å»ºè®®ï¼Œåªéœ€è¦å®¢è§‚åˆ†æå¸‚åœºçŠ¶æ€ã€‚

---

# ğŸ“Š ä½ æ‹¥æœ‰çš„å®Œæ•´æ•°æ®

- **åŸå§‹åºåˆ—**: 3åˆ†é’Ÿä»·æ ¼åºåˆ—(MidPricesæ•°ç»„) + 4å°æ—¶Kçº¿åºåˆ—
- **æŠ€æœ¯åºåˆ—**: EMA20åºåˆ—ã€MACDåºåˆ—ã€RSI7åºåˆ—ã€RSI14åºåˆ—ã€ATRåºåˆ—
- **èµ„é‡‘åºåˆ—**: æˆäº¤é‡åºåˆ—ã€æŒä»“é‡(OI)æ•°æ®ã€èµ„é‡‘è´¹ç‡
- **æ—¶é—´æ¡†æ¶**: æ—¥å†…çŸ­æœŸ(3åˆ†é’Ÿ) + ä¸­é•¿æœŸè¶‹åŠ¿(4å°æ—¶)

---

# ğŸ” åˆ†ææ–¹æ³•

ä½ å¯ä»¥è‡ªç”±è¿ç”¨ä»¥ä¸‹åˆ†ææ–¹æ³•ï¼ˆä¸é™äºæ­¤ï¼‰ï¼š

**è¶‹åŠ¿åˆ†æ**:
- ä»·æ ¼æ˜¯å¦çªç ´å…³é”®å‡çº¿ï¼ˆEMA20/EMA50ï¼‰
- å¤šå‘¨æœŸè¶‹åŠ¿ä¸€è‡´æ€§ï¼ˆ3åˆ†é’Ÿ vs 4å°æ—¶ï¼‰
- æ”¯æ’‘ä½å’Œé˜»åŠ›ä½è¯†åˆ«

**åŠ¨é‡åˆ†æ**:
- RSI è¶…ä¹°è¶…å–çŠ¶æ€ï¼ˆRSI7 å’Œ RSI14ï¼‰
- MACD é‡‘å‰æ­»å‰ã€æŸ±çŠ¶å›¾å˜åŒ–
- ä»·æ ¼åŠ¨é‡ä¸æŒ‡æ ‡èƒŒç¦»

**é‡ä»·åˆ†æ**:
- æˆäº¤é‡æ”¾å¤§/èç¼©
- é‡ä»·é…åˆæƒ…å†µï¼ˆæ¶¨é‡è·Œç¼© vs æ¶¨ç¼©è·Œé‡ï¼‰
- æŒä»“é‡å˜åŒ–è¶‹åŠ¿

**æ³¢åŠ¨åˆ†æ**:
- ATR æ³¢åŠ¨ç‡æ°´å¹³
- ä»·æ ¼æ³¢åŠ¨èŒƒå›´
- æ½œåœ¨çš„çˆ†å‘æˆ–æ”¶æ•›

**èµ„é‡‘é¢**:
- èµ„é‡‘è´¹ç‡æ­£è´Ÿï¼ˆåšå¤š/åšç©ºæƒ…ç»ªï¼‰
- æŒä»“é‡å˜åŒ–ï¼ˆèµ„é‡‘æµå…¥/æµå‡ºï¼‰

---

# ğŸ“‹ åˆ†ææµç¨‹

1. **æ•´ä½“è¯„ä¼°**: å½“å‰ BTC å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿï¼ˆä¸Šæ¶¨/ä¸‹è·Œ/éœ‡è¡ï¼‰
2. **æŠ€æœ¯é¢åˆ†æ**:
   - 3åˆ†é’Ÿçº§åˆ«ï¼šçŸ­æœŸåŠ¨é‡å¦‚ä½•ï¼Ÿ
   - 4å°æ—¶çº§åˆ«ï¼šä¸­æœŸè¶‹åŠ¿å¦‚ä½•ï¼Ÿ
   - å¤šå‘¨æœŸæ˜¯å¦ä¸€è‡´ï¼Ÿ
3. **å…³é”®ä¿¡å·è¯†åˆ«**:
   - æœ‰å“ªäº›é‡è¦çš„æŠ€æœ¯ä¿¡å·ï¼Ÿï¼ˆé‡‘å‰ã€çªç ´ã€èƒŒç¦»ç­‰ï¼‰
   - å“ªäº›æŒ‡æ ‡æœ€é‡è¦ï¼Ÿ
4. **è¶‹åŠ¿é¢„æµ‹**:
   - æœªæ¥1å°æ—¶ï¼šå¯èƒ½çš„èµ°åŠ¿æ–¹å‘å’Œå…³é”®ä»·ä½
   - æœªæ¥4å°æ—¶ï¼šä¸­æœŸè¶‹åŠ¿æ–¹å‘
5. **é£é™©ç‚¹**:
   - éœ€è¦å…³æ³¨çš„æ”¯æ’‘/é˜»åŠ›ä½
   - å¯èƒ½çš„åè½¬ä¿¡å·

---

# ğŸ“¤ è¾“å‡ºæ ¼å¼

**ç¬¬ä¸€æ­¥: æ€ç»´é“¾åˆ†æï¼ˆç®€æ´æ¸…æ™°çš„æ–‡æœ¬ï¼‰**

ç”¨ç®€æ´çš„è¯­è¨€åˆ†æä½ çš„æ€è€ƒè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- æ•´ä½“å¸‚åœºçŠ¶æ€åˆ¤æ–­
- å…³é”®æŠ€æœ¯æŒ‡æ ‡åˆ†æ
- è¶‹åŠ¿é¢„æµ‹ä¾æ®
- é£é™©æç¤º

**ç¬¬äºŒæ­¥: JSONæ ¼å¼çš„ç»“æ„åŒ–æ€»ç»“**

```json
{
  "market_state": "ä¸Šæ¶¨è¶‹åŠ¿ | ä¸‹è·Œè¶‹åŠ¿ | éœ‡è¡æ•´ç† | è¶‹åŠ¿è½¬æŠ˜",
  "short_term_trend": "1å°æ—¶å†…å¯èƒ½èµ°åŠ¿çš„æè¿°",
  "mid_term_trend": "4å°æ—¶å†…å¯èƒ½èµ°åŠ¿çš„æè¿°",
  "key_levels": {
    "support": ä»·æ ¼æ”¯æ’‘ä½,
    "resistance": ä»·æ ¼é˜»åŠ›ä½
  },
  "confidence": 75,
  "key_signals": [
    "ä¿¡å·1æè¿°",
    "ä¿¡å·2æè¿°"
  ],
  "risk_warning": "é£é™©æç¤ºæ–‡å­—",
  "summary": "ä¸€å¥è¯æ€»ç»“å½“å‰å¸‚åœº"
}
```

---

**è®°ä½**:
- å®¢è§‚åˆ†æï¼Œä¸å¸¦ä¸ªäººå€¾å‘
- åŸºäºæ•°æ®ï¼Œä¸å‡­æ„Ÿè§‰
- è¯†åˆ«ä¿¡å·å¼ºåº¦ï¼ˆå¼º/ä¸­/å¼±ï¼‰
- æ ‡æ³¨ä¸ç¡®å®šæ€§å’Œé£é™©
"""
    return prompt


def build_user_prompt(market_data: Dict, runtime_minutes: int = 0, call_count: int = 0) -> str:
    """
    æ„å»º User Promptï¼ˆåŠ¨æ€å¸‚åœºæ•°æ®ï¼‰
    æ”¹ç¼–è‡ª NOFX çš„ buildUserPrompt() å‡½æ•°

    Args:
        market_data: å¸‚åœºæ•°æ®å­—å…¸ï¼ˆæ¥è‡ª market_data.pyï¼‰
        runtime_minutes: ç³»ç»Ÿè¿è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
        call_count: AI è°ƒç”¨æ¬¡æ•°

    Returns:
        æ ¼å¼åŒ–çš„ user prompt å­—ç¬¦ä¸²
    """
    lines = []

    # === ç³»ç»ŸçŠ¶æ€ ===
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    lines.append(f"**æ—¶é—´**: {current_time} | **å‘¨æœŸ**: #{call_count} | **è¿è¡Œ**: {runtime_minutes}åˆ†é’Ÿ\n")

    # === BTC å¸‚åœºæ¦‚è§ˆ ===
    lines.append("## ğŸ“Š BTC å¸‚åœºæ¦‚è§ˆ\n")
    lines.append(f"**å½“å‰ä»·æ ¼**: ${market_data['current_price']:,.2f}")
    lines.append(f"**1å°æ—¶æ¶¨è·Œ**: {market_data['price_change_1h']:+.2f}%")
    lines.append(f"**4å°æ—¶æ¶¨è·Œ**: {market_data['price_change_4h']:+.2f}%")
    lines.append(f"**MACD**: {market_data['current_macd']:.4f}")
    lines.append(f"**RSI(7)**: {market_data['current_rsi7']:.2f}\n")

    # === æŠ€æœ¯æŒ‡æ ‡è¯¦æƒ… ===
    lines.append("## ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡è¯¦æƒ…\n")

    # çŸ­æœŸæŒ‡æ ‡ï¼ˆ3åˆ†é’Ÿï¼‰
    lines.append("### æ—¥å†…çŸ­æœŸ (3åˆ†é’Ÿ)\n")
    lines.append(f"**EMA20**: ${market_data['current_ema20']:.2f}")

    intraday = market_data['intraday_series']
    lines.append(f"**ä»·æ ¼åºåˆ—** (æœ€è¿‘20ä¸ªç‚¹): ")
    lines.append(f"  â€¢ æœ€é«˜: ${max(intraday['mid_prices']):.2f}")
    lines.append(f"  â€¢ æœ€ä½: ${min(intraday['mid_prices']):.2f}")
    lines.append(f"  â€¢ å®Œæ•´åºåˆ—: {[f'{p:.2f}' for p in intraday['mid_prices'][-10:]]}")  # æœ€è¿‘10ä¸ªç‚¹
    lines.append("")

    lines.append(f"**MACDåºåˆ—** (æœ€è¿‘10ä¸ªç‚¹): {[f'{v:.4f}' for v in intraday['macd_values'][-10:]]}")
    lines.append(f"**RSI(7)åºåˆ—** (æœ€è¿‘10ä¸ªç‚¹): {[f'{v:.2f}' for v in intraday['rsi7_values'][-10:]]}")
    lines.append(f"**RSI(14)åºåˆ—** (æœ€è¿‘10ä¸ªç‚¹): {[f'{v:.2f}' for v in intraday['rsi14_values'][-10:]]}\n")

    # é•¿æœŸæŒ‡æ ‡ï¼ˆ4å°æ—¶ï¼‰
    longer_term = market_data['longer_term_context']
    lines.append("### ä¸­é•¿æœŸè¶‹åŠ¿ (4å°æ—¶)\n")
    lines.append(f"**EMA20**: ${longer_term['ema20']:.2f}")
    lines.append(f"**EMA50**: ${longer_term['ema50']:.2f}")
    lines.append(f"**ATR(3)**: {longer_term['atr3']:.2f}")
    lines.append(f"**ATR(14)**: {longer_term['atr14']:.2f}")
    lines.append("")

    lines.append(f"**æˆäº¤é‡**: ")
    lines.append(f"  â€¢ å½“å‰: {longer_term['current_volume']:,.2f}")
    lines.append(f"  â€¢ å¹³å‡: {longer_term['average_volume']:,.2f}")
    volume_ratio = (longer_term['current_volume'] / longer_term['average_volume'] * 100) if longer_term['average_volume'] > 0 else 0
    lines.append(f"  â€¢ æ¯”ç‡: {volume_ratio:.1f}% (å½“å‰/å¹³å‡)")
    lines.append("")

    lines.append(f"**MACDåºåˆ— (4h, æœ€è¿‘10ä¸ªç‚¹)**: {[f'{v:.4f}' for v in longer_term['macd_values'][-10:]]}")
    lines.append(f"**RSI(14)åºåˆ— (4h, æœ€è¿‘10ä¸ªç‚¹)**: {[f'{v:.2f}' for v in longer_term['rsi14_values'][-10:]]}\n")

    # === å¸‚åœºèµ„é‡‘é¢ ===
    lines.append("## ğŸ’° å¸‚åœºèµ„é‡‘é¢\n")
    oi = market_data['open_interest']
    lines.append(f"**æŒä»“é‡**: {oi['latest']:,.0f} BTC")
    lines.append(f"**èµ„é‡‘è´¹ç‡**: {market_data['funding_rate']:.6f} ({market_data['funding_rate']*100:.4f}%)")

    # èµ„é‡‘è´¹ç‡è§£è¯»
    if market_data['funding_rate'] > 0.0001:
        lines.append(f"  â†’ åšå¤šèµ„é‡‘è´¹ç‡åé«˜ï¼Œå¸‚åœºçœ‹å¤šæƒ…ç»ªè¾ƒå¼º")
    elif market_data['funding_rate'] < -0.0001:
        lines.append(f"  â†’ åšç©ºèµ„é‡‘è´¹ç‡åé«˜ï¼Œå¸‚åœºçœ‹ç©ºæƒ…ç»ªè¾ƒå¼º")
    else:
        lines.append(f"  â†’ èµ„é‡‘è´¹ç‡æ¥è¿‘ä¸­æ€§ï¼Œå¤šç©ºç›¸å¯¹å¹³è¡¡")
    lines.append("")

    # === è¯·æ±‚AIåˆ†æ ===
    lines.append("---\n")
    lines.append("è¯·åŸºäºä»¥ä¸Šå®Œæ•´çš„å¸‚åœºæ•°æ®ï¼Œè¿›è¡Œæ·±åº¦åˆ†æï¼š")
    lines.append("1. åˆ¤æ–­å½“å‰å¸‚åœºæ•´ä½“çŠ¶æ€ï¼ˆä¸Šæ¶¨/ä¸‹è·Œ/éœ‡è¡ï¼‰")
    lines.append("2. åˆ†æå…³é”®æŠ€æœ¯æŒ‡æ ‡ä¿¡å·")
    lines.append("3. é¢„æµ‹æœªæ¥ 1-4 å°æ—¶å¯èƒ½çš„èµ°åŠ¿")
    lines.append("4. æ ‡æ³¨å…³é”®çš„æ”¯æ’‘/é˜»åŠ›ä½å’Œé£é™©ç‚¹")
    lines.append("")
    lines.append("**è¾“å‡ºæ ¼å¼**: æ€ç»´é“¾åˆ†æ + JSONç»“æ„åŒ–æ€»ç»“\n")

    return "\n".join(lines)


def format_analysis_result(cot_trace: str, json_result: Dict) -> str:
    """
    æ ¼å¼åŒ–åˆ†æç»“æœç”¨äº Telegram æ¶ˆæ¯ï¼ˆHTML æ ¼å¼ï¼‰

    Args:
        cot_trace: æ€ç»´é“¾åˆ†ææ–‡æœ¬
        json_result: ç»“æ„åŒ–åˆ†æç»“æœï¼ˆJSONï¼‰

    Returns:
        HTML æ ¼å¼çš„æ¶ˆæ¯å­—ç¬¦ä¸²
    """
    lines = []

    # è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
    def escape_html(text):
        if not isinstance(text, str):
            text = str(text)
        return text.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')

    lines.append("ğŸ¤– <b>BTC å¸‚åœºåˆ†ææŠ¥å‘Š</b>\n")
    lines.append("â”" * 40)
    lines.append("")

    # ä¸€å¥è¯æ€»ç»“
    if 'summary' in json_result:
        summary = escape_html(json_result['summary'])
        lines.append(f"ğŸ“Œ <b>æ€»ç»“</b>: {summary}\n")

    # å¸‚åœºçŠ¶æ€
    if 'market_state' in json_result:
        state_emoji = {
            "ä¸Šæ¶¨è¶‹åŠ¿": "ğŸ“ˆ",
            "ä¸‹è·Œè¶‹åŠ¿": "ğŸ“‰",
            "éœ‡è¡æ•´ç†": "â†”ï¸",
            "è¶‹åŠ¿è½¬æŠ˜": "ğŸ”„"
        }
        emoji = state_emoji.get(json_result['market_state'], "ğŸ“Š")
        market_state = escape_html(json_result['market_state'])
        lines.append(f"{emoji} <b>å¸‚åœºçŠ¶æ€</b>: {market_state}\n")

    # è¶‹åŠ¿é¢„æµ‹
    if 'short_term_trend' in json_result:
        trend = escape_html(json_result['short_term_trend'])
        lines.append(f"â° <b>çŸ­æœŸ(1h)</b>: {trend}")
    if 'mid_term_trend' in json_result:
        trend = escape_html(json_result['mid_term_trend'])
        lines.append(f"â³ <b>ä¸­æœŸ(4h)</b>: {trend}\n")

    # å…³é”®ä»·ä½
    if 'key_levels' in json_result:
        levels = json_result['key_levels']
        lines.append("ğŸ¯ <b>å…³é”®ä»·ä½</b>:")
        if 'resistance' in levels:
            lines.append(f"  â€¢ é˜»åŠ›ä½: ${levels['resistance']:,.2f}")
        if 'support' in levels:
            lines.append(f"  â€¢ æ”¯æ’‘ä½: ${levels['support']:,.2f}")
        lines.append("")

    # å…³é”®ä¿¡å·
    if 'key_signals' in json_result and json_result['key_signals']:
        lines.append("âš¡ <b>å…³é”®ä¿¡å·</b>:")
        for signal in json_result['key_signals']:
            signal_text = escape_html(signal)
            lines.append(f"  â€¢ {signal_text}")
        lines.append("")

    # é£é™©æç¤º
    if 'risk_warning' in json_result:
        warning = escape_html(json_result['risk_warning'])
        lines.append(f"âš ï¸ <b>é£é™©æç¤º</b>: {warning}\n")

    # ä¿¡å¿ƒåº¦
    if 'confidence' in json_result:
        confidence = json_result['confidence']
        confidence_level = "é«˜" if confidence >= 80 else "ä¸­" if confidence >= 60 else "ä½"
        lines.append(f"ğŸ“Š <b>åˆ†æä¿¡å¿ƒåº¦</b>: {confidence}% ({confidence_level})\n")

    lines.append("â”" * 40)
    lines.append("")

    # æ€ç»´é“¾ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
    lines.append("ğŸ’­ <b>AI åˆ†æè¿‡ç¨‹</b>:")
    cot_preview = cot_trace[:400] if len(cot_trace) > 400 else cot_trace
    cot_escaped = escape_html(cot_preview)
    lines.append(f"<pre>{cot_escaped}</pre>")
    if len(cot_trace) > 400:
        lines.append("<i>... (å®Œæ•´åˆ†æå·²ä¿å­˜åˆ°æ—¥å¿—)</i>")

    return "\n".join(lines)
